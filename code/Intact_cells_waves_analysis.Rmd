---
title: "Automatic report"
author: "Ruben Lopez"
date: "Generated on: `r format(Sys.time(), '%d.%m.%Y')`"
output:
  html_document: default
  word_document: default
editor_options:
  chunk_output_type: inline
---

# Analysis of Ca^2+^ waves in intact cells



```{r, setup, echo=FALSE}
## Setting enviroment
knitr::opts_chunk$set(
  comment = '', fig.width= 6, fig.asp = 0.8, warning=FALSE, message=FALSE, results='hide', include=FALSE, echo=FALSE)
```



------------------------------------------------------------------------

```{r}

############# Importing libraries #############

pacman::p_load(AnlysisOfWaves, # custom functions for analysis and loading of additional libraries
               here, fs, # folder's system navigation,
               readxl,
               readr,
               cowplot,
               purrr, dplyr, tidyr, stringr, kableExtra, # wrangling data
               ggplot2, # piloting
               lmerTest, broom.mixed, emmeans) # tools for mixed effect model computation and multiple comparison

options("scipen" = 999, "digits" = 4)

```



```{r}

############# Create folder and names structure #############

# name of parameters for analysis
parameters <- list("kinetics", "frequency", "occurence") %>% 
                                purrr::set_names()
parameters

# name of output directories for each parameter
output_results_dir <- map(parameters, ~(sprintf(here("results",
                               "intact_cells",
                               "wave_%s"), .x)))
output_results_dir
# output_result


# name of output directories for figures
# output_figs_dir <- bind_cols(list(laten_and_freq = "Figures/Intact_cells/Waves_late_freq_occu" , 
#                              wave_kinet = "Figures/Intact_cells/Waves_kinetics", 
#                              combi_panel = "Figures/Intact_cells/Combined_pannel"))

output_figs_dir <-here("figures", "intact_cells") %>% 
  list() %>% 
  set_names(nm = "intact_cells")
    # dir.exists()
    
    
output_figs_dir$intact_cells

table_output_font_size = 10

output_figs_dir
```


We load the excel file containing the features extracted form the linescan images. They also contain relevant additional information such as date, animal, treatments, etc.


```{r}

############# Loading the raw dataset from the excel file ############# 

df40 <-as.data.frame(read_xlsx(here("datasets", 
                                    "intact_cells",
                                    "pooled_IntactCells_WL_WS_EAP_OCC_CAFF.xlsx"),
                               sheet = 1, skip = 13))
 df40 %>% 
   head
```



```{r}

############# repare names, etc ############# 

df40 <- df40 %>% # Remove the "_mean" suffix of some variable names.
  rename_all(~str_replace(., pattern = "_mean", replacement = "")) 

df40 <- df40[-17] # remove extra column "Wave_latency"
colnames(df40) [16] <- "Wave_latency" # <- USE ONLY THIS variable for wave latency, since it's repeated
colnames(df40) [18] <-  "Wave_Freq_Hz"
colnames(df40) [24] <-  "EAP_Latency"

# transforming in s units latency and EAP
df40$Wave_latency <- df40$Wave_latency / 1000 # changing wave latency units from ms to seconds
df40$EAP_Latency <- df40$EAP_Latency / 1000 # changing EAP latency units from ms to seconds


# 5. Setting as factor several variables ----
df40$Condition[df40$Condition == "Iso_3'"] <- "ISO"
# df40$Condition <- factor(df40$Condition, levels = c("Control", "ISO"))

df40$Animal[df40$Animal == "CPVT-HET"] <- "CPVT"
df40$Animal[df40$Animal == "CPVT-WT"] <- "WT"

df40 <- df40 %>%
  # df40 %>% 
    mutate(Groups = factor(paste(Condition,
                                 Animal ,
                                 sep = "_"),
                           levels = c("Control_WT",
                                      "Control_CPVT",
                                      "ISO_WT",
                                      "ISO_CPVT"))) %>%
    mutate(across(starts_with(c("Date", "Condition", "Animal", "For")), as.factor) ) %>%
    mutate(Experiment = factor(str_sub(filename, 10, 15)),
           core_name = str_sub(filename, 1, -5),
           filename = factor(filename),
           Animal = factor(Animal, levels = c("WT", "CPVT"))) 


```


We define a time window (in seconds) threshold for later determine the occurrence of waves and frequency.

```{r}
wave_or_EAP_threshold <- 10
```

which is `r wave_or_EAP_threshold` seconds. 

### Create variables namespace

We take the columns names from the excel sheet and create the set of variables names of the various features of interest for later use.

```{r}

# this are the variables names for spontaneous waves kinetics (de-skewed)
wave_kinet_parameters <- df40 %>%
  select(starts_with("Wave_") / (contains(c("50", "late", "Freq")))) %>% 
  names() %>% 
  rev() %>% # revert order
  set_names() %>% 
  map(~.x) 


# this are the variables names for spontaneous waves occurrence and frequency
wave_lat_and_freq <- df40 %>%
  select(starts_with("Wave_") / contains("5") & ends_with(c("cy", "Hz"))) %>%
  names() %>% 
  set_names() %>% 
  map(~.x) 

# this are the variables names for spontaneous electrical-stimulated Calcium transients 
trans_kinet_parameters <- df40 %>%
  select(starts_with("Trans_") / (contains(c("50", "late", "Freq")))) %>%
  names() %>% 
  rev() %>% # revert order
  set_names() %>% 
  map(~.x) 


# log10_wave_kinet_parameters <- wave_kinet_parameters %>% 
#   names %>%
#   set_names(nm = paste0("log10_",.)) %>% 
#   map(~paste0("log10_",.x))


# this are the variables names for Caffeine-induced transients 
caff_parameters <- df40 %>%
  select(starts_with("Caff") / (contains(c("50")))) %>%
  names() %>% 
  rev() %>% # revert order
  set_names() %>% 
  map(~.x) 


```

### Keep only ok experiments

Based on the notes, We take only the subset of the dataset that were considered good for analysis, that is, successful experiments.

```{r}

#filtering: removing no responding experiments
df40$`For_Wave_Kinetics_Analysis?`[df40$core_name %in% c("20181115 L1 CS1 Cell A0002", "20190118 L2 CS4 Cell A0002", 
                                                             "20181213 L1 CS3 Cell A0001", "20181213 L1 CS3 Cell A0002")] <- "no"

# 6. Taking only the data for Occurrency analysis = yes ----

df40_o <- (subset(df40, df40$`For Occu Analysis?`== "yes"))

rm(df40)

```


And this is how it looks a subset of the the full curated dataset 

```{r results='show', include=TRUE}

df40_o %>% 
  kable %>%
  kable_styling(font_size = table_output_font_size) %>% 
  scroll_box(width = "100%", height = "400px")
  # kable(format= "latex", booktabs = T) %>% 

```


### checking the files for repository -> no done yet


```{r}
df40_o %>% 
  # names
  distinct(filename) %>% 
  arrange(desc(filename))
```



# Statistics

## Descriptive stats

We compute descriptive statistics to observe the data quality, trend, etc...



```{r}
# df40_o %>% 
#   filter(`For_Wave_Kinetics_Analysis?` == "yes") %>%
#   clean_and_tidy_df_func(vars_for_analysis = wave_kinet_parameters) %>% 
#   my_summ_stat_func()
```

we nest the full raw dataset.


```{r}

# We group and nest the data

all_parameters = c(wave_kinet_parameters,
                   wave_lat_and_freq,
                   trans_kinet_parameters,
                   caff_parameters)


nested_df <- df40_o %>%
 select(!starts_with(c("Gender", "Protocol", "Chip", "notes",  "Total")) &
           !contains(c("ms", "EAP", "Age", "t50")) & 
           where(~  is.numeric(.x) || is.factor(.x))) %>% 
  pivot_longer(cols = as.character(all_parameters), names_to = "variables" ) %>%
  group_by(variables) %>%
  nest 
   
nested_df
```



You are here -> NOTE: to make properly the summary stats, you need first to subset the data for analysis respectively


### Wave kinetics


Compute and export summary of wave kinetics parameters

```{r}

wave_kinetics_df_nest <- nested_df %>%
  filter(variables %in% as.character(wave_kinet_parameters)) %>% #take only the datad=set for wavekinetics
  mutate(data = map(data, ~(.x %>% 
                              filter(`For_Wave_Kinetics_Analysis?` == "yes") ))) %>% 
  describe_nested_df(targed_dataset = "data")


wave_kinetics_df_nest
```

Here are the summary statistics of the wave kinetics parameters: `r as.character(wave_kinet_parameters)`

```{r results='show', include=TRUE}
wave_kinetics_df_nest %>% 
  unnest(described) %>% 
  arrange(variables, Condition) %>% 
  select(-data, -Parameters, -where(is.list)) %>% 
  # kableExtra::kable(format = "latex", booktabs = T)
  kable %>%
  kable_styling(font_size = table_output_font_size)
```
#### Export summry statistics results

Here we export the descriptive statistics from the wave kinetics parameters: `r as.character(wave_kinet_parameters)` and can be found in the directory: `r output_results_dir$kinetics`

> Change to `eval = TRUE` when you want to export the results.

```{r eval = FALSE}
wave_kinetics_df_nest %>% 
  unnest(described) %>% 
  arrange(variables, Condition) %>% 
  select(-data, -Parameters, -where(is.list)) %>% 
  write_csv(paste(output_results_dir$kinetics, 
                  paste(format(Sys.time(),
                               '%Y%m%d'),
                        "summary_stats.csv",
                        sep = "_"), sep = "/"))
```


#### QQ-plots of wave kinetics parameters


```{r, results='show', include=TRUE, collapse = TRUE, fig.width=12, fig.asp = 0.3, out.width='100%'}
wave_kinetics_df_nest %>% 
  mutate(qq_plot = map(qq_plot, ~.x +  
                         ggplot2::scale_colour_manual(values = c("#666666", 
                                                                 "#CC0000")) +
                         ggplot2::scale_fill_manual(values = c("#666666", 
                                                                 "#CC0000")) +
                         pptx_presentation_theme_func(base_size = 12))) %>% 
  pluck("qq_plot") %>% 
  plot_grid(plotlist = ., ncol = 3)
```





### Frequency and latency

```{r}
wave_freq_df_nest <- nested_df %>%
  filter(variables %in% as.character(wave_lat_and_freq)) %>% #take only the datad=set for wavekinetics
  mutate(data = map(data, ~(.x %>% 
                              filter(`For Occu Analysis?` == "yes") ))) %>% 
  describe_nested_df(targed_dataset = "data")

wave_freq_df_nest
```

Here are the summary statistics of the wave frequency parameters: `r as.character(wave_lat_and_freq)`

```{r results='show', include=TRUE}
wave_freq_df_nest %>% 
  unnest(described) %>% 
  arrange(variables, Condition) %>% 
  select(-data, -Parameters, -where(is.list)) %>% 
  # kableExtra::kable(format = "latex", booktabs = T)
  kable %>%
  kable_styling(font_size = table_output_font_size)

```

#### Export summry statistics results

Here we export the descriptive statistics from the wave Frequency parameters: `r wave_lat_and_freq` and can be found in the directory: `r output_results_dir$frequency`

> Change to `eval = TRUE` when you want to export the results.

```{r eval = FALSE}
wave_freq_df_nest %>% 
  unnest(described) %>% 
  arrange(variables, Condition) %>% 
  select(-data, -Parameters, -where(is.list)) %>% 
  write_csv(paste(output_results_dir$frequency, 
                  paste(format(Sys.time(),
                               '%Y%m%d'),
                        "summary_stats.csv",
                        sep = "_"), sep = "/"))
```


#### QQ-plots of wave kinetics parameters


```{r results='show', include=TRUE, collapse = TRUE, fig.width=12, fig.asp = 0.3, out.width='200%'}
wave_freq_df_nest %>% 
   mutate(qq_plot = map(qq_plot, ~.x +  
                         ggplot2::scale_colour_manual(values = c("#666666", 
                                                                 "#CC0000")) +
                         ggplot2::scale_fill_manual(values = c("#666666", 
                                                                 "#CC0000")) +
                         pptx_presentation_theme_func(base_size = 12))) %>% 
  pluck("qq_plot") %>% 
  plot_grid(plotlist = ., ncol = 3)
  # plot_grid(plotlist = ., ncol = 1)
  
  
```


## Hypothesis testing

### Testing for the wave kinetics parameters

Let's first define the model that describe our hypothesis which describe our kinetics parameters by the fix effects:  Genotype (WT/CPVT) or Drug condition (Control/ISO?others..) and random effect is the Animal ID.

```{r}
nointer_mixmodel <- function(my_dataset){
  lmerTest::lmer(value ~ Animal + Condition + (1|Animal_No), 
                 data = my_dataset,
                 REML = FALSE)
}
```

We can test for a second model whit similar describers but using interaction

```{r}
inter_mixmodel <- function(my_dataset){
  lmerTest::lmer(value ~ Animal * Condition + (1|Animal_No), 
                 data = my_dataset,
                 REML = FALSE)
}
```


```{r}
model_raw_nsdf <- wave_kinetics_df_nest %>% 
  select(data) %>% 
  apply_model_func(my_model = nointer_mixmodel) %>% 
  apply_model_func(my_model = inter_mixmodel) %>% 
  pivot_longer(cols = ends_with("model"), 
               names_to = "model_name", 
               values_to = "model")
  

# model_raw_nsdf
  
```
>NOTE:this two functions should go to the package `extract_model_info` and `plot_residuals`

```{r}
extract_model_info <- function(ns_df){
  my_parameter_name <- sym(names(ns_df)[1])
  ns_df %>% 
  # pivot_longer(cols = ends_with("model"), 
  #              names_to = "model_name", 
  #              values_to = "model") %>% 
    mutate(across(model,
                list(glance = ~ map(.x, ~ broom::glance(.x)),
                     tidy =  ~ map(.x, ~ broom::tidy(.x)),
                     augment =  ~ map(.x, ~ broom::augment(.x))),
                     # augment =  ~ map(.x, ~ (broom::augment(.x) %>% 
                     #                           mutate(.student.resid = .resid / .sigma * sqrt(1 - .hat))))), # compute inside the augment column the studentized residuals
                .names = "{.fn}")) %>% 
    mutate(logLik = (glance %>% map_dbl(~ .x$logLik * -2)),
         AIC = (glance %>% map_dbl(~ .x$AIC)),
         BIC = (glance %>% map_dbl(~ .x$BIC)),
         # p_val = (glance %>% map_dbl(~ .x$p.value)),
         # sigma = (glance %>% map_dbl(~ .x$sigma))) %>% 
         p_val = map(model,  ~(.x %>%
                                 car::Anova() %>%
                                 broom::tidy())))
}
```



```{r}
plot_residuals <- function(model_nsdf, augmented_df = "augment"){
  augmented_df <- sym(augmented_df)
  my_parameter_name <- sym(names(model_nsdf)[1])
  model_name <- sym(names(model_nsdf)[3])
  

  
  model_nsdf %>%
    group_by(model_name, .add = T) %>%
    mutate(res_vs_fit_plot = map(!!augmented_df, ~ {
      .x  %>%
        # ungroup %>%
        ggplot(aes(x = .fitted,
                   y = .resid,
                   color = Animal,
                   shape = Condition)) +
        geom_point() +
        geom_hline(yintercept = 0,
                   color = "black",
                   linetype = "dashed",
                   alpha = 0.5) +
        facet_grid(. ~ Condition  + Animal ) +
        ggplot2::scale_colour_manual(values = c("#666666",
                                                "#CC0000")) +
        ggplot2::scale_fill_manual(values = c("#666666",
                                              "#CC0000")) +
        # ggplot2::ggtitle(label = paste0("Parameter = ", !!my_parameter_name)) + # this work for parameter name
        # ggplot2::ggtitle(label = paste("Model = ", !!model_name,  sep = "_")) +
        ggplot2::ggtitle(label = paste(paste0("Parameter = ", !!my_parameter_name),
                                        paste0("Model = ", !!model_name), sep  = "\n")) +
        
        # ggplot2::ggtitle(label = paste0("Model = ", !!model_name)) +
        pptx_presentation_theme_func(base_size = 12) + 
        theme(plot.title = element_text(size=12))

    }))

}
```



Extract information and Inspect model performance

```{r}
model_results_nsdf <- model_raw_nsdf %>% 
  extract_model_info() %>% 
  plot_residuals()
# model_results_nsdf
```




```{r results='show', include=TRUE, collapse = TRUE, fig.width=16, fig.asp = 1.3, out.width='200%'}
wave_kinet_parameters %>% 
  map(~(model_results_nsdf %>% 
          ungroup() %>% 
          filter(variables == .x ) %>% 
          pull(res_vs_fit_plot) %>% 
          plot_grid(plotlist = ., ncol = 2))) %>% 
  plot_grid(plotlist = ., ncol = 1)
```

### Make Contrast

firat we design a matrix to make the mdesired comparisons

```{r}
emmens_ns_df$em_means[[1]] %>% 
  coef

```

```{r}
contrast_matrix <- list("WT_Control vs CPVT_Control" = c(1, 0, 0, 0) - c(0, 1, 0, 0),
                        "WT_ISO vs CPVT_IS0" = c(0, 0, 1, 0) - c(0, 0, 0, 1))
contrast_matrix
```


```{r}
emmens_ns_df <- model_raw_nsdf %>%
# model_raw_nsdf %>%
  # filter(str_detect(model_name, "no")) %>% 
  mutate(em_means = map2(data, model, ~ emmeans(object =  .y, 
                                                specs =  ~ Animal * Condition, 
                                                data = .x)),
         # estimates = map(em_means, ~(.x$emmeans %>%
         estimates = map(em_means, ~(.x %>%
                                       as_tibble %>%
                                       drop_na %>%
                                       mutate(across(where(is.double),
                                                     ~ round(.x, digits =2))))),
         # contrasts = map(em_means, ~(.x$contrasts %>% 
         #                               as_tibble %>% 
         #                               drop_na %>% 
         #                               mutate(across(where(is.double), 
         #                                             ~ round(.x, digits =2))))))#,
         contrast = map(em_means, ~(.x %>%
                                        contrast(method = contrast_matrix, adjust = "BH") %>%
                                        as_tibble %>%
                                        drop_na %>%
                                        mutate(across(where(is.double),
                                                      ~ round(.x, digits =2)))))) #%>%
  # pluck("contrast_2", 2)
  # pluck("em_means", 2)

emmens_ns_df

```

```{r}
emmens_ns_df %>% 
  select(variables, model_name, contrast) %>% 
  unnest(cols = contrast) %>% 
  filter(!str_detect(model_name, "no"))
```


```{r}
contrast(emmens_ns_df$em_means[[1]], contrast_matrix)

emmens_ns_df$em_means[[1]][[2]] %>%
# emmens_ns_df$model[[1]] %>% 
  coef
```


```{r}
emmens_ns_df #%>% 
  filter(str_detect(variables, "FF0")) %>% 
  # pull(estimates)
  pull(contrasts)
```


### Export results

wave_kinet_parameters


# Ploting 

## Make kinetics superplots

```{r}
wave_kinetics_df_nest %>% 
  mutate(sup_plots = map(data, ~ multi_plot_list_func(my_dataset = .x,
                                                      yaxe = wave_kinet_parameters,
                                                      my_plot_fun = superplot_func,
                                                      base_violin = "cells",
                                                      dot_layer = "none",
                                                      animal_layer = T,
                                                      wave_alpha = 0.4,
                                                      wave_size = 1,
                                                      cell_size = 2.5,
                                                      cell_alpha = 0.4,
                                                      animal_size = 7,
                                                      animal_alpha = 0.7,
                                                      base_font_size = 36,
                                                      line_size = 1.5)))
         
         
wave_kinet_parameters %>% 
  map(~sym(as.character(.x)))
```
```{r}
wave_kinet_parameters %>% 
  map(~sym(.x))
```


```{r}
wave_kinetics_df_nest$data[[1]] %>% 
  superplot_func(yaxe = wave_kinet_parameters,
                 # my_plot_fun = superplot_func,
                 base_violin = "cells",
                 dot_layer = "none",
                 animal_layer = T,
                 wave_alpha = 0.4,
                 wave_size = 1,
                 cell_size = 2.5,
                 cell_alpha = 0.4,
                 animal_size = 7,
                 animal_alpha = 0.7,
                 base_font_size = 36,
                 line_size = 1.5)
```


NOTE: fix issue with the superplot function and listed names.


# outline 

- 1. [x] Descriptive stats and export results 

- 2. [ ] Hypothesis testing (make mix model) and export results 

                  <- You are here -> 

- 3. [ ] Standard Plot and export figures 

                  <- You are here -> 

- 4. [ ] Repre traces and export results 



- 5. [ ] render all images in this document? 




