---
title: "Automatic report"
author: "Ruben Lopez"
date: "Generated on: `r format(Sys.time(), '%d.%m.%Y')`"
output:
  html_document: default
  word_document: default
editor_options:
  chunk_output_type: inline
---

# Analysis of Ca^2+^ waves in intact cells



```{r, setup, echo=FALSE}
## Setting enviroment
knitr::opts_chunk$set(
  comment = '', fig.width= 6, fig.asp = 0.8, warning=FALSE, message=FALSE, results='hide', include=FALSE, echo=FALSE)
```



------------------------------------------------------------------------

```{r}

############# Importing libraries #############

pacman::p_load(AnlysisOfWaves, # custom functions for analysis and loading of additioanl libraries
               here, # folder's system navigation,
               readxl,
               readr,
               cowplot,
               purrr, dplyr, tidyr, stringr, kableExtra, # wrangling data
               lmerTest, broom.mixed) # tools for mixed effect model computation

options("scipen" = 999, "digits" = 4)

```



```{r}

############# Create folder and names structure #############

# name of parameters for analysis
parameters <- list("kinetics", "frequency", "occurence") %>% 
                                purrr::set_names()
parameters

# name of output directories for each parameter
output_results_dir <- map(parameters, ~(sprintf(here("results",
                               "intact_cells",
                               "wave_%s"), .x)))
   output_results_dir
# output_result


# name of output directories for figures
# output_figs_dir <- bind_cols(list(laten_and_freq = "Figures/Intact_cells/Waves_late_freq_occu" , 
#                              wave_kinet = "Figures/Intact_cells/Waves_kinetics", 
#                              combi_panel = "Figures/Intact_cells/Combined_pannel"))

   output_figs_dir <-here("figures", "Intact_cells") %>% 
     list() %>% 
     set_names(nm = "intact_cells")
    # dir.exists()
    
    
output_figs_dir$intact_cells

table_output_font_size = 10
```


We load the excel file containing the features extracted form the linescan images. They also contain relevant additional information such as date, animal, treatments, etc.


```{r}

############# Loading the raw dataset from the excel file ############# 

df40 <-as.data.frame(read_xlsx(here("datasets", 
                                    "intact_cells",
                                    "pooled_IntactCells_WL_WS_EAP_OCC_CAFF.xlsx"),
                               sheet = 1, skip = 13))
 df40 %>% 
   head
```



```{r}

############# repare names, etc ############# 

df40 <- df40 %>% # Remove the "_mean" suffix of some variable names.
  rename_all(~str_replace(., pattern = "_mean", replacement = "")) 

df40 <- df40[-17] # remove extra column "Wave_latency"
colnames(df40) [16] <- "Wave_latency" # <- USE ONLY THIS variable for wave latency, since it's repeated
colnames(df40) [18] <-  "Wave_Freq_Hz"
colnames(df40) [24] <-  "EAP_Latency"

# transforming in s units latency and EAP
df40$Wave_latency <- df40$Wave_latency / 1000 # changing wave latency units from ms to seconds
df40$EAP_Latency <- df40$EAP_Latency / 1000 # changing EAP latency units from ms to seconds


# 5. Setting as factor several variables ----
df40$Condition[df40$Condition == "Iso_3'"] <- "ISO"
# df40$Condition <- factor(df40$Condition, levels = c("Control", "ISO"))

df40$Animal[df40$Animal == "CPVT-HET"] <- "CPVT"
df40$Animal[df40$Animal == "CPVT-WT"] <- "WT"

df40 <- df40 %>%
  # df40 %>% 
    mutate(Groups = factor(paste(Condition,
                                 Animal ,
                                 sep = "_"),
                           levels = c("Control_WT",
                                      "Control_CPVT",
                                      "ISO_WT",
                                      "ISO_CPVT"))) %>%
    mutate(across(starts_with(c("Date", "Condition", "Animal", "For")), as.factor) ) %>%
    mutate(Experiment = factor(str_sub(filename, 10, 15)),
           core_name = str_sub(filename, 1, -5),
           filename = factor(filename),
           Animal = factor(Animal, levels = c("WT", "CPVT"))) 


```


We define a time window (in seconds) threshold for later determine the occurrence of waves and frequency.

```{r}
wave_or_EAP_threshold <- 10
```

which is `r wave_or_EAP_threshold` seconds. 

### Create variables namespace

We take the columns names from the excel sheet and create the set of variables names of the various features of interest for later use.

```{r}

# this are the variables names for spontaneous waves kinetics (de-skewed)
wave_kinet_parameters <- df40 %>%
  select(starts_with("Wave_") / (contains(c("50", "late", "Freq")))) %>% 
  names() %>% 
  rev() %>% # revert order
  set_names() %>% 
  map(~.x) 


# this are the variables names for spontaneous waves occurrence and frequency
wave_lat_and_freq <- df40 %>%
  select(starts_with("Wave_") / contains("5") & ends_with(c("cy", "Hz"))) %>%
  names() %>% 
  set_names() %>% 
  map(~.x) 

# this are the variables names for spontaneous electrical-stimulated Calcium transients 
trans_kinet_parameters <- df40 %>%
  select(starts_with("Trans_") / (contains(c("50", "late", "Freq")))) %>%
  names() %>% 
  rev() %>% # revert order
  set_names() %>% 
  map(~.x) 


# log10_wave_kinet_parameters <- wave_kinet_parameters %>% 
#   names %>%
#   set_names(nm = paste0("log10_",.)) %>% 
#   map(~paste0("log10_",.x))


# this are the variables names for Caffeine-induced transients 
caff_parameters <- df40 %>%
  select(starts_with("Caff") / (contains(c("50")))) %>%
  names() %>% 
  rev() %>% # revert order
  set_names() %>% 
  map(~.x) 


```

### Keep only ok experiments

Based on the notes, We take only the subset of the dataset that were considered good for analysis, that is, successful experiments.

```{r}

#filtering: removing no responding experiments
df40$`For_Wave_Kinetics_Analysis?`[df40$core_name %in% c("20181115 L1 CS1 Cell A0002", "20190118 L2 CS4 Cell A0002", 
                                                             "20181213 L1 CS3 Cell A0001", "20181213 L1 CS3 Cell A0002")] <- "no"

# 6. Taking only the data for Occurrency analysis = yes ----

df40_o <- (subset(df40, df40$`For Occu Analysis?`== "yes"))

rm(df40)

```


And this is how it looks a subset of the the full curated dataset 

```{r results='show', include=TRUE}

df40_o %>% 
  kable %>%
  kable_styling(font_size = table_output_font_size) %>% 
  scroll_box(width = "100%", height = "400px")
  # kable(format= "latex", booktabs = T) %>% 

```


### checking the files for repository -> no done yet


```{r}
df40_o %>% 
  # names
  distinct(filename) %>% 
  arrange(desc(filename))
```



# Statistics

## Descriptive stats

We compute descriptive statistics to observe the data quality, trend, etc...



```{r}
# df40_o %>% 
#   filter(`For_Wave_Kinetics_Analysis?` == "yes") %>%
#   clean_and_tidy_df_func(vars_for_analysis = wave_kinet_parameters) %>% 
#   my_summ_stat_func()
```

we nest the full raw dataset.


```{r}

# We group and nest the data

all_parameters = c(wave_kinet_parameters,
                   wave_lat_and_freq,
                   trans_kinet_parameters,
                   caff_parameters)


nested_df <- df40_o %>%
 select(!starts_with(c("Gender", "Protocol", "Chip", "notes",  "Total")) &
           !contains(c("ms", "EAP", "Age", "t50")) & 
           where(~  is.numeric(.x) || is.factor(.x))) %>% 
  pivot_longer(cols = as.character(all_parameters), names_to = "variables" ) %>%
  group_by(variables) %>%
  nest 
   
nested_df
```



You are here -> NOTE: to make properly the summary stats, you need first to subset the data for analysis respectively


### Wave kinetics


Compute and export summary of wave kinetics parameters

```{r}

wave_kinetics_df_nest <- nested_df %>%
  filter(variables %in% as.character(wave_kinet_parameters)) %>% #take only the datad=set for wavekinetics
  mutate(data = map(data, ~(.x %>% 
                              filter(`For_Wave_Kinetics_Analysis?` == "yes") ))) %>% 
  describe_nested_df(targed_dataset = "data")


wave_kinetics_df_nest
```

Here are the summary statistics of the wave kinetics parameters: `r as.character(wave_kinet_parameters)`

```{r results='show', include=TRUE}
wave_kinetics_df_nest %>% 
  unnest(described) %>% 
  arrange(variables, Condition) %>% 
  select(-data, -Parameters, -where(is.list)) %>% 
  # kableExtra::kable(format = "latex", booktabs = T)
  kable %>%
  kable_styling(font_size = table_output_font_size)
```
#### Export summry statistics results

Here we export the descriptive statistics from the wave kinetics parameters: `r as.character(wave_kinet_parameters)` and can be found in the directory: `r output_results_dir$kinetics`

```{r}
wave_kinetics_df_nest %>% 
  unnest(described) %>% 
  arrange(variables, Condition) %>% 
  select(-data, -Parameters, -where(is.list)) %>% 
  write_csv(paste(output_results_dir$kinetics, 
                  paste(format(Sys.time(),
                               '%Y%m%d'),
                        "summary_stats.csv",
                        sep = "_"), sep = "/"))
  
```


#### QQ-plots of wave kinetics parameters


```{r, results='show', include=TRUE, collapse = TRUE, fig.width=12, fig.asp = 0.3, out.width='100%'}
wave_kinetics_df_nest %>% 
  mutate(qq_plot = map(qq_plot, ~.x +  
                         ggplot2::scale_colour_manual(values = c("#666666", 
                                                                 "#CC0000")) +
                         ggplot2::scale_fill_manual(values = c("#666666", 
                                                                 "#CC0000")) +
                         pptx_presentation_theme_func(base_size = 12))) %>% 
  pluck("qq_plot") %>% 
  plot_grid(plotlist = ., ncol = 3)
```





### Frequency and latency

```{r}
wave_freq_df_nest <- nested_df %>%
  filter(variables %in% as.character(wave_lat_and_freq)) %>% #take only the datad=set for wavekinetics
  mutate(data = map(data, ~(.x %>% 
                              filter(`For Occu Analysis?` == "yes") ))) %>% 
  describe_nested_df(targed_dataset = "data")

wave_freq_df_nest
```

Here are the summary statistics of the wave frequency parameters: `r as.character(wave_lat_and_freq)`

```{r results='show', include=TRUE}
wave_freq_df_nest %>% 
  unnest(described) %>% 
  arrange(variables, Condition) %>% 
  select(-data, -Parameters, -where(is.list)) %>% 
  # kableExtra::kable(format = "latex", booktabs = T)
  kable %>%
  kable_styling(font_size = table_output_font_size)

```

#### Export summry statistics results

Here we export the descriptive statistics from the wave Frequency parameters: `r wave_lat_and_freq` and can be found in the directory: `r output_results_dir$frequency`

```{r}
wave_freq_df_nest %>% 
  unnest(described) %>% 
  arrange(variables, Condition) %>% 
  select(-data, -Parameters, -where(is.list)) %>% 
  write_csv(paste(output_results_dir$frequency, 
                  paste(format(Sys.time(),
                               '%Y%m%d'),
                        "summary_stats.csv",
                        sep = "_"), sep = "/"))
  
```


#### QQ-plots of wave kinetics parameters


```{r results='show', include=TRUE, collapse = TRUE, fig.width=12, fig.asp = 0.3, out.width='200%'}
wave_freq_df_nest %>% 
   mutate(qq_plot = map(qq_plot, ~.x +  
                         ggplot2::scale_colour_manual(values = c("#666666", 
                                                                 "#CC0000")) +
                         ggplot2::scale_fill_manual(values = c("#666666", 
                                                                 "#CC0000")) +
                         pptx_presentation_theme_func(base_size = 12))) %>% 
  pluck("qq_plot") %>% 
  plot_grid(plotlist = ., ncol = 3)
  # plot_grid(plotlist = ., ncol = 1)
  
  
```


## Hypothesis testing

### Testing for the wave kinetics parameters

Let's first define the model that describe our hypothesis which describe our kinetics parameters by the fix effects:  Genotype (WT/CPVT) or Drug condition (Control/ISO?others..) and random effect is the Animal ID.

```{r}
nointer_mixmodel <- function(my_dataset){
  lmerTest::lmer(value ~ Animal + Condition + (1|Animal_No), 
                 data = my_dataset,
                 REML = FALSE)
}
```

We can test for a second model whit similar describers but using interaction

```{r}
inter_mixmodel <- function(my_dataset){
  lmerTest::lmer(value ~ Animal * Condition + (1|Animal_No), 
                 data = my_dataset,
                 REML = FALSE)
}
```


```{r}
model_raw_nsdf <- wave_kinetics_df_nest %>% 
  select(data) %>% 
  apply_model_func(my_model = nointer_mixmodel) %>% 
  apply_model_func(my_model = inter_mixmodel)
```
```{r}
extract_model_info <- function(ns_df){
  ns_df %>% 
  pivot_longer(cols = ends_with("model"), 
               names_to = "model_name", 
               values_to = "model")
}
```

```{r}
model_raw_nsdf %>% 
  # pivot_longer(cols = ends_with("model"), 
  #              names_to = "model_name", 
  #              values_to = "model")
  extract_model_info()
```


# outline 

- 1. Descriptive stats and export results ✓

- 2. Hypothesis testing (make mix model) and export results

You are here -> NOTE: to make properly the summary stats, you need first to subset the data for analysis of each variable respectively

- 3. Standard Plot and export figures

- 4. Repre traces and export results. 

- 5. render all images in this document?




